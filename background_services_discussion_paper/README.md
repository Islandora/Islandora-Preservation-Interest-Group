# Islandora Background Processes Discussion Paper
Mark Jordan, July 21, 2014

## Overview and purpose of this document

This document proposes an alternative to the way that most derivatives are currently created by Islandora solution packs and describes a generalized framework for Islandora that can accommodate both external (e.g., RESTful) services and background processes running on the Drupal server. The proposed alternative can coexist with currently available solution packs, and microservice-based approaches to creating derivatives, if the solution packs are modified slightly. 

The document also introduces a proof-of-concept implementation that demonstrates using a RESTful Optical Character Recognition service to create Islandora datastreams.

The purpose of the document is to encourage discussion around how the Islandora community, and communities supporting other repository platforms, can support a healthy ecosystem of services that can be shared across institutions, that require zero (or near-zero) configuration, and that are highly scalable.

## Derivative creation in Islandora

Islandora solution packs typically create derivatives from the OBJ datastream as it is uploaded by the user in the target collection’s ingest form. Uploading of the user’s file, creating the derivatives, and submitting the ingest form are performed in sequence. Solution packs create derivatives by implementing either hook_islandora_derivative() or hook_CMODEL_PID_islandora_derivative(), both of which define some metadata about the derivative and then call a solution-pack-specific function that in turn calls an external program (usually through PHP’s exec() function) to create the derivative file. For example, the Audio Solution Pack calls the LAME utility to generate MP3 files using the following PHP code:

```php
 $command = "$lame_url -V5 --vbr-new \"$file\" \"$outfile\"";
 $ret = FALSE;
 exec($command, $output, $ret);
```

Exec() calls LAME in the same PHP process that is executing the user’s submission of the ingest form. Since the form submission process takes as long to run as the sum of all the tasks it performs, potentially long-running tasks like creating MP3 files can result in a long-running form submission action. This not only results in sub-optimal user experience (the user doesn’t know why the form submission is taking so long), but also can result in timeouts imposed by PHP or the web server software. 

PHP, like many programming languages, supports the spawning of multiple processes within the same script. Using this technique, it is possible to minimize the situation described in the previous paragraph, and to have each task performed by PHP independently of the main script, in effect performing the tasks asynchronously, in parallel with the maintain script. If separate processes are created, the execution time of the main script (for example, the Drupal form submission) will not be determined by the sum of all of the tasks’ execution time, it will be determined only by the tasks that are performed within the main script. The new processes do not impact the overall execution time of the main script.

In addition to introducing the possibility of long-running ingest form submissions, Islandora solution packs frequently hard-code the external program (and its command-line parameters) into the solution pack module code. Many solution packs allow for some configuration via standard Drupal module admin settings forms, but the hard-coded external program, and the parameters used to execute it, are usually the only ones available within a given solution pack. Local implementers cannot use alternative external programs or varying parameters to create derivatives without modifying the solution pack code.

While hard-coding external programs to create derivatives reduces Islandora’s complexity and simplifies the installation of individual solution packs, it can complicate an institution’s ability to create derivatives within Islandora and outside of Islandora consistently. This issue is particularly evident within the context of institution-wide digital preservation strategies, where an institution’s preservation plan for specific file formats or content types may not be consistent with the derivatives created by Islandora solution packs.

Combined, the “single process” approach to creating derivatives, and the tight binding of those external programs and their parameters with solution pack code, can lead to scalability problems when ingesting large quantities of content, to difficulties in integrating Islandora into local content production, management, and preservation workflows, and to the introduction of local workarounds to compensate for unwanted functionality.

A Drupal contrib module, [Background Process](https://www.drupal.org/project/background_process),  provides a simple API for running tasks as independent processes. The module also integrates with the Drupal Cron and Queue subsystems, and provides a listing of running processes it manages ([screenshot](https://www.drupal.org/files/project-images/Screen%20Shot%202012-10-21%20at%2011.39.11%20AM.png)). In the remainder of this document, I will describe how this module can be used as the basis for the generalized services framework mentioned in the overview. 

## Microservices

Some Islandora implementers avoid using standard solution packs for creating derivatives in favor of external programs known as "microservices." This approach shifts the creation of derivatives from Drupal code to external programs that listen to the Fedora Repository’s JMS (Java Message Service) Broker. In this model, a set of “listeners” wait for specific events to be recorded in the JMS and respond by sending information to the [Taverna Workflow Engine](http://www.taverna.org.uk/), which is used to coordinate interaction between the listeners and the microservices, which in turn generate derivatives and add them to the appropriate Islandora objects (microservices can be used to perform other tasks as well). This strategy successfully avoids the “single process” problem described above. Two microservice implementations are the University of Prince Edward Island’s, available at  https://github.com/roblib/php_listeners and https://github.com/roblib/islandora_microservices_monitor, and Discovery Gardens’, available at https://github.com/discoverygarden/islandora_microservices. UPEI staff recently presented on their microservices at the [2014 Open Repositories Conference](http://urn.fi/URN:NBN:fi-fe2014070432321).

While these microservice approaches have proven to be highly scalable and performant, they have not been implemented widely outside of the two organizations that developed them.

## Pluggable, sharable external services: an example

The approach to external services advocated in this document (the “background process approach”) spawns separate processes that create or modify derivatives from within Islandora modules through capabilities provided by the Background Proces contrib module, and uses purpose-built yet simple Islandora modules to manage specific services. Services can run locally (on the same server as the Islandora Drupal instance) as independent PHP, Python, or Ruby (for example) scripts, or on another server using ssh/scp or via a REST or other HTTP-based interface.

This approach differs from UPEI’s and Discovery Gardens’ microservices in that it does not listen to the Fedora JMS, and it does not use an external workflow engine. Tasks are performed in response to the firing of standard Islandora ingest, modify, and alter hooks (listed below). While the microservices approach is more sophisticated (chiefly because it uses a workflow engine), it is also more complex.

The remainder of this section describes a working sample implementation that generates an OCR derivative datastream from an image file. The sample implementation has three components: an [external REST server](https://github.com/mjordan/ocr_rest) that performs the OCR, an [Islandora module to configure and integrate that service](https://github.com/mjordan/islandora_bprocess_ocr), and a [generic framework module](https://github.com/mjordan/islandora_background_process) that implements a set of standard Islandora hooks that are fired when objects or datastreams are ingested or altered.

The OCR REST server is not specific to Islandora or Drupal; it is fully compliant with standard REST conventions and can be used by any authorized client. It receives a PUT request from a client containing the image to be OCRed, then generates a text or [hOCR](http://en.wikipedia.org/wiki/HOCR) transcript for the image during a subsequent GET request. It also allows clients to delete images and transcripts when they no longer need them via HTTP DELETE. The server application is a thin HTTP wrapper around the [Tesseract OCR engine](http://code.google.com/p/tesseract-ocr/).

The generic framework module, called [Islandora Background Process](https://github.com/mjordan/islandora_background_process), implements the following standard Islanodra hooks: 

* hook_islandora_object_ingested
* hook_islandora_object_modified
* hook_islandora_object_alter
* hook_islandora_datastream_ingested
* hook_islandora_datastream_modified, and
* hook_islandora_datastream_alter

Code within the module’s hook functions inspects all of the objects that extend an abstract IslandoraBackgroundProcess class (provided by the Islandora Background Process module) and detects which objects are to be passed off to the Background Process module within each hook for creation of a new process. The hook then invokes the extending object’s work() method, passing in either an Islandora $object or an Islandora $object and $datastream as parameters, depending on the hook it is invoked from. The purpose of the abstract IslandoraBackgroundProcess class is to define predictable properties and a method that all child objects implement, and also to provide a mechanism for efficient object introspection within the Islandora hooks listed above.

The third component (the [“Islandora Background Process OCR Service” module](https://github.com/mjordan/islandora_bprocess_ocr)), is the Islandora module that enables local site adminstrators to configure Islandora’s interaction with the remote REST service and that also integrates the REST OCR service into the generic Islandora Background Process framework by instantiating an object that extends IslandoraBackgroundProcess. The work() method within this object contains the code that calls the REST service and then, after the OCR transcripts have been generated, adds the transcripts to the appropriate Islandora object. Below is a diagram illustrating how the components work together: 

![Islandora Background Services Overview Diagram](https://dl.dropboxusercontent.com/u/1015702/linked_to/externalservicesinislandora/Supporting_external_services_in_Islandora_overview_diagram.png)

The nodes in the diagram that are surrounded by a dotted line comprise the external service (specifically, the service itself and the module that integrates it with Islandora). The Islandora Background Process module and the Drupal contrib module Background Process (surrounded by the dashed line) are drop in, zero-configuration Drupal modules.

The first benefit of this approach is that adding a new service is straightforward (assuming that the external REST, web, or local service is operational and available): all that is required in addition to the external service itself is a single Drupal module that calls the service and provides any necessary configuration options. As an example of how simple this type of module can be, the Islandora Background Process OCR Service’s .module file is less than [40 lines long](https://github.com/mjordan/islandora_bprocess_ocr/blob/7.x/islandora_bprocess_ocr.module), and its class file that extends IslandoraBackgroundProcess is just under [140 lines long](https://github.com/mjordan/islandora_bprocess_ocr/blob/7.x/includes/IslandoraBprocessOcr.inc). Adding this particular service is as simple as installing, enabling, and configuring the module by indicating the URL and path of the REST OCR server and selecting the local Islandora collections and content models to apply the service to):

![Islandora Background Process OCR Service](https://dl.dropboxusercontent.com/u/1015702/linked_to/externalservicesinislandora/islandora_background_process_ocr_service.png)

The second, and perhaps more important, benefit is that external services become sharable across Islandora instances: a single OCR REST server could serve many Islandora instances. It would also be easy to scale such a service horizontally by using a service endpoint randomizer or other techniques. Sharable services would also make deploying Islandora easier, since using an external service that is already running and available relieves local administrators of installing server-level dependencies. Third, the remote service can be incrementally improved or even replaced with minimal disruption to Islandora consumers. Finally, integration modules encapsulate all of the code necessary to interact with the external service, so they can be distributed and managed like other Islandora modules. In general, external services (combined with their respective integration modules) are “unpluggable” from Islandora, and alternatives can be plugged in, as long as they produce suitable datastreams.

An important consequence of using asynchronous processes to create derivatives is that a derivative can take considerably longer to create (and add to its parent object) than the submission of the ingest form. This is acceptable for derivatives that are not shown to the user by default at the end of the ingest form submission process. However, datastreams that are shown to the end user at the end of ingest form submission (there are many examples, including the ‘PREVIEW’ datastream in the PDF Content Model, the ‘JPG’ datastream in the Web ARChive Content Model) may not be created or added to the parent object by the time that the form submission completes. The behavior of the object display in this situation varies across solution packs and also across viewers configured for use with specific content models. It is possible to check for the existence of the derivative when the object is viewed but a suitable generalized way to respond to a not-yet-ready datastream needs to be investigated.

## Integration into existing Islandora solution packs and intersection with other repository platforms

As described earlier, standard Islandora solution packs implement either hook_islandora_derivative() or hook_CMODEL_PID_islandora_derivative(), and then add the newly created datastream to its parent object. This behavior is typically hard coded into solution packs. The only solution pack that currently provides a configuration option to not create derivatives using its own code is the Newspaper Solution Pack, which assumes that externally created derivatives are created by UPEI’s or Discovery Gardens’ microservices.

Ideally, integrating the external services framework described here with existing solution packs would require a minimal amount of code-level changes to the solution packs yet provide graceful fallbacks to their built-in functionality. The simplest integration would require that solution packs provide a simple configuration option to turn off their built-in derivative creation, as the [Newspaper Solution Pack](https://github.com/Islandora/islandora_solution_pack_newspaper) currently does:

![Newspaper Solution Pack Derivatives Options](https://dl.dropboxusercontent.com/u/1015702/linked_to/externalservicesinislandora/newspaperspconfig.png)

Adding this option to other solution packs would allow the approach described in this document to work, and maintain compatibility with other approaches to using external services such as UPEI’s and Discovery Gardens’ microservices.

However, additional ways of integrating with existing solution packs exist. For example, a more complex approach would be to create a registry of content models and collections that are configured to use specific external services, similar to Drupal’s class and theme registries, and from within existing solution packs’ implementations of _derivative() hooks, compare the incoming Islandora object and its datastreams with this registry. If there is a match, the external service is used; if there is no match, the solution pack’s derivative-creation functions are used. The Islandora Background Process module could provide the function that checks the registry; existing solution packs would only need to add a call to that function and logic to bypass their built-in derivative-creation functions.

The Islandora Background Process module and the Islandora Background Process OCR Service module used in the sample implementation are specific to Islandora, but the OCR REST server is agnostic to clients other than requiring that they be able to issue specific REST requests over HTTP (although the server does make some assumptions about the formats of images it receives and the types of transcripts it generates). One of greatest advantages of allowing Islandora to use external services via a flexible, low-configuration framework is promoting shared services accross Islandora instances and across repository platforms. Developing and deploying effective external services, especially ones that can be used by any repository platform the way that REST or web services can, benefits the entire repository community.

## Remaining work

In addition to integrating the background process module into existing Islandora solution packs (preferably using the simple solution of providing options to not use each solution pack’s internal derivative-creation functions), the only other issue that needs to be resolved, as described earlier, is that there is no mechanism for indicating to the user ingesting an object that a derivative used in an object’s default display is not yet ready. Addressing this issue will likely require changes to existing solution packs and viewers.

It would also be useful to explore ways that multiple extenal services could be chained together so they can perform complex tasks. For instance, to extend our example of generating an OCR transcript for a page, we could have a additional background service fire that would take the plain text transcript and submit it to the [DBpedia Spotlight](https://github.com/dbpedia-spotlight/dbpedia-spotlight/wiki/Web-service) web service to extract Linked Data entities from it, and then add those entities to Fedora's triplestore.

## Conclusion

The approach to external services described in this document offers the potential for centrally or collaboratively hosted services to be shared by multiple Islandora instances and also by other repository platforms. Recent discussions between members of the Islandora community and the developers of Archivematica about allowing external clients to consume Archivematica’s services lay the ground for a potential application of this approach that could benefit multiple repository platforms. More broadly, the use of commodity services such as those listed at http://www.programmableweb.com/apis/directory can add substantial value to all repository platforms.

<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.